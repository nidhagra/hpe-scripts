
#
# RL_3X_FIN_RZ_L2_SO_DOR_LEGL_CO_D_ETL.py
#

import os
import json
import io
import sys
from datetime import datetime
from pyspark.sql import SparkSession, DataFrame, Row, SQLContext
from pyspark import SparkContext
from pyspark.sql.window import Window
import pyspark.sql.types as T
import pyspark.sql.functions as F

def fetch_schema_name(stmt_id, spark_session, schema_name):
    print("fetching schema name for {schema_name}".format(schema_name=schema_name))
    ret_val = None
    try:
        df = spark_session.sql("select param_value from edw_control.param_env where param_nm = '{schema_name}';".format(schema_name=schema_name))
        if df.count() > 0:
            df.show(10, False)
            data = df.collect()
            #print(data)
            ret_val_list = [ row.param_value for row in data ]
            #print(ret_val_list)
            ret_val = ret_val_list[0]
            print("param value for {schema_name} -- {ret_val}".format(schema_name=schema_name, ret_val=ret_val))
        else:
            ret_val = None
    except Exception as e:
        print("ERROR {}".format(str(e)))
        ret_val = None
    return ret_val

def fetch_param_value(stmt_id, spark_session, param_name):
    print("fetching value for {param_name}".format(param_name=param_name))
    ret_val = None
    try:
        query_string="""
        select concat('Select ', column_nm, ' as ', param_nm, ' from ', table_nm, ' ', clause, ';' )
        from edw_control.param_mapping
        where param_nm = '{param_name}';
        """.format(param_name=param_name)
        df = spark_session.sql(query_string)
        if df.count() > 0:
            df.show(10, False)
            data = df.collect()
            q_list = [ row[0] for row in data ]
            q = q_list[0]
            df2 = spark_session.sql(q)
            if df2.count() > 0:
                df2.show(10, False)
                data2 = df2.collect()
                r_list = [ row[0] for row in data2 ]
                ret_val = r_list[0]
                print("param value for {param_name} -- {ret_val}".format(param_name=param_name, ret_val=ret_val))
            else:
                ret_val = None
        else:
            ret_val = None
    except Exception as e:
        print("ERROR {}".format(str(e)))
        ret_val = None
    return ret_val

def execute_sql(stmt_id, spark_session, spark_context, sql_context, query_string):
    print("executing {stmt_id} - {query_string}".format(stmt_id=stmt_id, query_string=query_string))
    ret_val = False
    try:
        spark_session.sql(query_string)
        ret_val = True
    except Exception as e:
        print("ERROR {}".format(str(e)))
        ret_val = False
    return ret_val

def execute():
    spark_session = (SparkSession.builder
        .config("spark.sql.extensions", "io.delta.sql.DeltaSparkSessionExtension")
        .getOrCreate()
    )
    spark_context = spark_session.sparkContext
    sql_context = SQLContext(spark_context)

    PARAM_SCHEMA_ETL_SCHEMA_s = fetch_schema_name("1", spark_session, "ETL_SCHEMA")
    if PARAM_SCHEMA_ETL_SCHEMA_s is None:
        print("ERROR fetching value for parameter 'PARAM_SCHEMA_ETL_SCHEMA_s'")
        sys.exit(1)
    query_to_execute = """USE {PARAM_SCHEMA_ETL_SCHEMA_s};""".format(PARAM_SCHEMA_ETL_SCHEMA_s=PARAM_SCHEMA_ETL_SCHEMA_s)
    ret_val = execute_sql("1", spark_session, spark_context, sql_context, query_to_execute)
    if ret_val is False:
        print("ERROR executing query {query_to_execute}".format(query_to_execute=query_to_execute))
        sys.exit(1)

    query_to_execute = """DELETE FROM STG_FIN_RZ_SO_DOR_LEGL_CO_D_ETL;""" 
    ret_val = execute_sql("2", spark_session, spark_context, sql_context, query_to_execute)
    if ret_val is False:
        print("ERROR executing query {query_to_execute}".format(query_to_execute=query_to_execute))
        sys.exit(2)

    #query_to_execute = """INSERT INTO STG_FIN_RZ_SO_DOR_LEGL_CO_D_ETL SELECT STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRC_SYS_KY,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_CRT_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.EFF_FRM_GMT_TS,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_LN_ITM_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BUS_AREA_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.EFF_TO_GMT_TS,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CROSS_BORD_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CONTRA_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.QTA_PROD_LN_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.FIN_CLOSE_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_REQD_DLVR_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLDT_CUST_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BILT_CUST_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SHPT_CUST_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.END_CUST_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.MGMT_GEO_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_DTL_STAT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_TYPE_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.OM_SRC_SYS_KY,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRC_PROD_LN_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_CHNL_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DOC_CRNCY_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.INVN_CLS_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SHIP_QT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_DTL_QT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.GRS_EXT_SO_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.GRS_EXT_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.NET_EXT_SO_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.NET_EXT_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_ADJ_SO_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_ADJ_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LEG_SO_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LEG_SO_LN_ITM_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.FUNC_AREA_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PRFT_CTR_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LEGL_CO_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_MTHD_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRVC_NOTIF_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_CRT_DT_YR_MTH_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DOC_EXCH_RT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DOC_MTH_3_EXCH_RT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DOC_MTH_12_EXCH_RT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LGCL_DEL_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.FIN_RPTBL_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DSTRB_CHNL_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_RSN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.VALU_DLVR_CHAIN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ACCT_MGR_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CMRCL_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_APP_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_CNTRCT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_PO_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.GOV_CNTRCT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.INDNT_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PRIM_AGNT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PROMO_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SECND_AGNT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SHPT_ISO_CTRY_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_OFF_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_ORG_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_REP_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BIG_DEAL_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BUS_TYPE_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PARNT_SO_LN_ITM_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PAYM_TERM_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PLNT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PROJ_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.QTA_CR_SUB_ENT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.REC_EXPLN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_FRC_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_SUB_ENT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_SLS_QT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SUPLYG_DIV_SUB_ENT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.WBS_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BASE_UNIT_OF_MSR_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.MATL_SLS_UNIT_OF_MSR_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PARNT_SO_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.NET_CNSTNT_3_MTH_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.NET_CNSTNT_12_MTH_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.REC_EXPLN_PRCS_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PARNT_PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.UNRSTD_BUS_AREA_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.TRSY_BUS_ORG_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CONV_TYPE_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CONV_RT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CBN_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORIG_PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.TEAM_CD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ADJ_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.QTA_PROD_LN_OVERR_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ADJ_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ADJ_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.GL_GRP_ACCT_ID,LEGL_CO_D.crncy_cd AS LC_CD,NVL(STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LC_EXCH_RT,crf.exch_rt) AS LC_EXCH_RT,NVL(STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LC_MTH_3_EXCH_RT,crf.MTH_3_EXCH_RT) AS LC_MTH_3_EXCH_RT,NVL(STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LC_MTH_12_EXCH_RT,crf.MTH_12_EXCH_RT) AS LC_MTH_12_EXCH_RT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.VOL_DRCT_CUST_NM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.MISC_CHRG_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PROD_OPT_MCC_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ADJ_ALLOC_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ACK_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_CMPGN_TX,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DLVR_MTHD_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.EIFFEL_INVN_CLS_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_MKT_PGM_TX,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRVC_GDS_PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRVC_GDS_QT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.USE_NM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.VALU_VOL_NM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CONSOLIDTD_INV_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DRCT_CUST_IND_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.REBATE_ORD_RSN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.FULLMT_MDL_DN ,0 AS NET_DEALER_PRC_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PKG_PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PRIM_SO_ADJ_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ENGMT_MDL_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_OPT_QT,0 AS NET_DEALER_PRC_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.MSTR_CNTRCT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CNTRCT_LN_ITM_NR_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SD_ITM_CATG_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.RTE_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_ACCT_GRP_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.REJ_RSN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CNTRCT_STRT_DT AS CNTRCT_STRT_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CNTRCT_END_DT AS CNTRCT_END_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_PREPAYM_TYPE_CD AS SO_PREPAYM_TYPE_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.TOT_NET_EXT_SO_AM AS TOT_NET_EXT_SO_AM FROM (SELECT STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRC_SYS_KY,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_CRT_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.EFF_FRM_GMT_TS,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_LN_ITM_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BUS_AREA_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.EFF_TO_GMT_TS,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CROSS_BORD_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CONTRA_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.QTA_PROD_LN_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.FIN_CLOSE_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_REQD_DLVR_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLDT_CUST_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BILT_CUST_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SHPT_CUST_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.END_CUST_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.MGMT_GEO_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_DTL_STAT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_TYPE_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.OM_SRC_SYS_KY,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRC_PROD_LN_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_CHNL_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DOC_CRNCY_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.INVN_CLS_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SHIP_QT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_DTL_QT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.GRS_EXT_SO_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.GRS_EXT_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.NET_EXT_SO_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.NET_EXT_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_ADJ_SO_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_ADJ_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LEG_SO_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LEG_SO_LN_ITM_ID,'?' AS FUNC_AREA_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PRFT_CTR_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LEGL_CO_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_MTHD_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRVC_NOTIF_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_CRT_DT_YR_MTH_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DOC_EXCH_RT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DOC_MTH_3_EXCH_RT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DOC_MTH_12_EXCH_RT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LGCL_DEL_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.FIN_RPTBL_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DSTRB_CHNL_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_RSN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.VALU_DLVR_CHAIN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ACCT_MGR_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CMRCL_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_APP_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_CNTRCT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_PO_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.GOV_CNTRCT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.INDNT_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PRIM_AGNT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PROMO_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SECND_AGNT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SHPT_ISO_CTRY_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_OFF_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_ORG_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_REP_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BIG_DEAL_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BUS_TYPE_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PARNT_SO_LN_ITM_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PAYM_TERM_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PLNT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PROJ_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.QTA_CR_SUB_ENT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.REC_EXPLN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_FRC_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_SUB_ENT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_SLS_QT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SUPLYG_DIV_SUB_ENT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.WBS_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BASE_UNIT_OF_MSR_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.MATL_SLS_UNIT_OF_MSR_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PARNT_SO_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.NET_CNSTNT_3_MTH_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.NET_CNSTNT_12_MTH_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.REC_EXPLN_PRCS_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PARNT_PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.UNRSTD_BUS_AREA_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.TRSY_BUS_ORG_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CONV_TYPE_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CONV_RT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CBN_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORIG_PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.TEAM_CD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ADJ_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.QTA_PROD_LN_OVERR_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ADJ_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ADJ_USD_AM,CASE WHEN (STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ADJ_CD = 'ZA01' ) THEN CASE WHEN (MAP1.GL_GRP_ACCT_ID IS NOT NULL ) THEN MAP1.GL_GRP_ACCT_ID ELSE NVL(MAP1.GL_GRP_ACCT_ID, '3091') END ELSE CASE WHEN (MAP2.GL_GRP_ACCT_ID IS NOT NULL ) THEN MAP2.GL_GRP_ACCT_ID ELSE NVL(MAP2.GL_GRP_ACCT_ID, '3199') END END AS GL_GRP_ACCT_ID,LEGL_CO_D.crncy_cd AS LC_CD,crf.exch_rt AS LC_EXCH_RT,crf.MTH_3_EXCH_RT AS LC_MTH_3_EXCH_RT,crf.MTH_12_EXCH_RT AS LC_MTH_12_EXCH_RT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.VOL_DRCT_CUST_NM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.MISC_CHRG_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PROD_OPT_MCC_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ADJ_ALLOC_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ACK_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_CMPGN_TX,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DLVR_MTHD_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.EIFFEL_INVN_CLS_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_MKT_PGM_TX,NVL(STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRVC_GDS_PROD_ID,'?') AS SRVC_GDS_PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRVC_GDS_QT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.USE_NM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.VALU_VOL_NM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CONSOLIDTD_INV_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DRCT_CUST_IND_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.REBATE_ORD_RSN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.FULLMT_MDL_DN ,NVL(STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PKG_PROD_ID,'?') AS PKG_PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PRIM_SO_ADJ_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ENGMT_MDL_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_OPT_QT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.MSTR_CNTRCT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CNTRCT_LN_ITM_NR_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SD_ITM_CATG_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.RTE_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_ACCT_GRP_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.REJ_RSN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CNTRCT_STRT_DT AS CNTRCT_STRT_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CNTRCT_END_DT AS CNTRCT_END_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_PREPAYM_TYPE_CD AS SO_PREPAYM_TYPE_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.TOT_NET_EXT_SO_AM AS TOT_NET_EXT_SO_AM FROM STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL INNER JOIN SRC_SYS_D SSD ON STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRC_SYS_KY = SSD.SRC_SYS_KY LEFT JOIN (SELECT SSD1.SPRN_CO_ID,CS1.GL_GRP_ACCT_ID,CS1.BUS_TYPE_CD,CS1.BUS_AREA_CD,CS1.ACCT_BOOK_TYPE_CD FROM CONTRA_BOOK_CASE_SRVCS CS1 INNER JOIN SRC_SYS_D SSD1 ON CS1.SRC_SYS_KY = SSD1.SRC_SYS_KY)MAP1 ON STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BUS_TYPE_CD = MAP1.BUS_TYPE_CD AND STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BUS_AREA_CD = MAP1.BUS_AREA_CD AND MAP1.ACCT_BOOK_TYPE_CD = 'G' AND SSD.SPRN_CO_ID = MAP1.SPRN_CO_ID LEFT JOIN (SELECT SSD2.SPRN_CO_ID,CS2.GL_GRP_ACCT_ID,CS2.BUS_TYPE_CD,CS2.BUS_AREA_CD,CS2.ACCT_BOOK_TYPE_CD FROM CONTRA_BOOK_CASE_SRVCS CS2 INNER JOIN SRC_SYS_D SSD2 ON CS2.SRC_SYS_KY = SSD2.SRC_SYS_KY)MAP2 ON STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BUS_TYPE_CD = MAP2.BUS_TYPE_CD AND STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BUS_AREA_CD = MAP2.BUS_AREA_CD AND MAP2.ACCT_BOOK_TYPE_CD = 'C' AND SSD.SPRN_CO_ID = MAP2.SPRN_CO_ID LEFT JOIN LEGL_CO_D LEGL_CO_D ON STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LEGL_CO_CD = LEGL_CO_D.LEGL_CO_CD AND SSD.ROLLUP_DFLT_CO_ID = LEGL_CO_D.SPRN_CO_ID LEFT JOIN crncy_rt_f crf ON STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ord_crt_dt_yr_mth_cd = crf.crncy_eff_yr_mth_cd AND STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.conv_type_id = crf.conv_type_id AND STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.conv_rt_cd = crf.conv_rt_cd AND STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.trsy_bus_org_cd = crf.trsy_bus_org_cd AND LEGL_CO_D.crncy_cd = crf.crncy_cd AND SSD.ROLLUP_DFLT_CO_ID = crf.SPRN_CO_ID  ) STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL INNER JOIN SRC_SYS_D SRC ON STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRC_SYS_KY = SRC.SRC_SYS_KY LEFT JOIN LEGL_CO_D LEGL_CO_D ON STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LEGL_CO_CD = LEGL_CO_D.LEGL_CO_CD AND SRC.ROLLUP_DFLT_CO_ID = LEGL_CO_D.SPRN_CO_ID LEFT JOIN crncy_rt_f crf ON (STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LC_EXCH_RT IS NULL OR STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LC_MTH_3_EXCH_RT IS NULL OR STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LC_MTH_12_EXCH_RT IS NULL) AND STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ord_crt_dt_yr_mth_cd = crf.crncy_eff_yr_mth_cd AND LEGL_CO_D.crncy_cd = crf.crncy_cd AND SRC.ROLLUP_DFLT_CO_ID = crf.SPRN_CO_ID AND (crf.SPRN_CO_ID,crf.conv_type_id,crf.conv_rt_cd,crf.trsy_bus_org_cd) IN (SELECT SPRN_CO_ID,conv_type_id,conv_rt_cd,trsy_bus_org_cd FROM crncy_conv WHERE (SPRN_CO_ID,crncy_conv_id, subj_area_id, src_sys_extrc_gmt_ts) in (SELECT SCC1.SPRN_CO_ID,scc1.crncy_conv_id, scc1.subj_area_id, MAX(scc1.src_sys_extrc_gmt_ts) FROM crncy_conv scc1 WHERE scc1.subj_area_id = 'ORDER' AND scc1.crncy_conv_id = 'UNKNOWN' GROUP BY SCC1.SPRN_CO_ID,scc1.crncy_conv_id, scc1.subj_area_id  )  )  ;""" 
    query_to_execute = """INSERT INTO STG_FIN_RZ_SO_DOR_LEGL_CO_D_ETL SELECT 
  STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ADJ_CD,
  STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRC_SYS_KY,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_LN_ITM_ID,
  STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_CRT_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.EFF_FRM_GMT_TS,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DOC_CRNCY_CD,
STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BUS_AREA_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.EFF_TO_GMT_TS,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CROSS_BORD_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CONTRA_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.QTA_PROD_LN_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.FIN_CLOSE_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_REQD_DLVR_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLDT_CUST_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BILT_CUST_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SHPT_CUST_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.END_CUST_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.MGMT_GEO_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_DTL_STAT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_TYPE_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.OM_SRC_SYS_KY,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRC_PROD_LN_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_CHNL_CD,
STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.INVN_CLS_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SHIP_QT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_DTL_QT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.GRS_EXT_SO_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.GRS_EXT_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.NET_EXT_SO_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.NET_EXT_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_ADJ_SO_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_ADJ_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LEG_SO_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LEG_SO_LN_ITM_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.FUNC_AREA_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PRFT_CTR_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LEGL_CO_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_MTHD_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRVC_NOTIF_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_CRT_DT_YR_MTH_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DOC_EXCH_RT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DOC_MTH_3_EXCH_RT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DOC_MTH_12_EXCH_RT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LGCL_DEL_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.FIN_RPTBL_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DSTRB_CHNL_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_RSN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.VALU_DLVR_CHAIN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ACCT_MGR_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CMRCL_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_APP_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_CNTRCT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_PO_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.GOV_CNTRCT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.INDNT_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PRIM_AGNT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PROMO_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SECND_AGNT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SHPT_ISO_CTRY_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_OFF_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_ORG_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_REP_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BIG_DEAL_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BUS_TYPE_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PARNT_SO_LN_ITM_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PAYM_TERM_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PLNT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PROJ_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.QTA_CR_SUB_ENT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.REC_EXPLN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_FRC_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_SUB_ENT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_SLS_QT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SUPLYG_DIV_SUB_ENT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.WBS_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BASE_UNIT_OF_MSR_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.MATL_SLS_UNIT_OF_MSR_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PARNT_SO_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.NET_CNSTNT_3_MTH_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.NET_CNSTNT_12_MTH_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.REC_EXPLN_PRCS_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PARNT_PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.UNRSTD_BUS_AREA_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.TRSY_BUS_ORG_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CONV_TYPE_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CONV_RT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CBN_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORIG_PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.TEAM_CD_ID,
STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.QTA_PROD_LN_OVERR_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ADJ_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ADJ_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.GL_GRP_ACCT_ID,LEGL_CO_D.crncy_cd AS LC_CD,NVL(STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LC_EXCH_RT,crf.exch_rt) AS LC_EXCH_RT,NVL(STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LC_MTH_3_EXCH_RT,crf.MTH_3_EXCH_RT) AS LC_MTH_3_EXCH_RT,NVL(STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LC_MTH_12_EXCH_RT,crf.MTH_12_EXCH_RT) AS LC_MTH_12_EXCH_RT,
,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.FULLMT_MDL_DN,0 AS NET_DEALER_PRC_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PRIM_SO_ADJ_CD,
STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.VOL_DRCT_CUST_NM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.MISC_CHRG_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PROD_OPT_MCC_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ADJ_ALLOC_FG,
0 AS STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_OPT_QT,
STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ACK_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_CMPGN_TX,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DLVR_MTHD_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.EIFFEL_INVN_CLS_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_MKT_PGM_TX,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PKG_PROD_ID,
STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRVC_GDS_PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRVC_GDS_QT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.USE_NM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.VALU_VOL_NM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CONSOLIDTD_INV_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DRCT_CUST_IND_CD,
STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ENGMT_MDL_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.REBATE_ORD_RSN_CD,
STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_OPT_QT,0 AS NET_DEALER_PRC_AM,
STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.MSTR_CNTRCT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CNTRCT_LN_ITM_NR_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SD_ITM_CATG_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.RTE_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_ACCT_GRP_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.REJ_RSN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CNTRCT_STRT_DT AS CNTRCT_STRT_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CNTRCT_END_DT AS CNTRCT_END_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_PREPAYM_TYPE_CD AS SO_PREPAYM_TYPE_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.TOT_NET_EXT_SO_AM AS TOT_NET_EXT_SO_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.TOT_NET_EXT_SO_USD_AM AS TOT_NET_EXT_SO_USD_AM FROM (SELECT STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRC_SYS_KY,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_CRT_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.EFF_FRM_GMT_TS,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_LN_ITM_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BUS_AREA_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.EFF_TO_GMT_TS,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CROSS_BORD_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CONTRA_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.QTA_PROD_LN_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.FIN_CLOSE_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_REQD_DLVR_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLDT_CUST_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BILT_CUST_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SHPT_CUST_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.END_CUST_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.MGMT_GEO_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_DTL_STAT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_TYPE_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.OM_SRC_SYS_KY,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRC_PROD_LN_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_CHNL_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DOC_CRNCY_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.INVN_CLS_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SHIP_QT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_DTL_QT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.GRS_EXT_SO_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.GRS_EXT_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.NET_EXT_SO_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.NET_EXT_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_ADJ_SO_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_ADJ_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LEG_SO_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LEG_SO_LN_ITM_ID,'?' AS FUNC_AREA_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PRFT_CTR_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LEGL_CO_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_MTHD_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRVC_NOTIF_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_CRT_DT_YR_MTH_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DOC_EXCH_RT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DOC_MTH_3_EXCH_RT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DOC_MTH_12_EXCH_RT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LGCL_DEL_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.FIN_RPTBL_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DSTRB_CHNL_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORD_RSN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.VALU_DLVR_CHAIN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ACCT_MGR_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CMRCL_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_APP_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_CNTRCT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_PO_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.GOV_CNTRCT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.INDNT_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PRIM_AGNT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PROMO_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SECND_AGNT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SHPT_ISO_CTRY_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_OFF_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_ORG_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_REP_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BIG_DEAL_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BUS_TYPE_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PARNT_SO_LN_ITM_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PAYM_TERM_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PLNT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PROJ_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.QTA_CR_SUB_ENT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.REC_EXPLN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_FRC_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SLS_SUB_ENT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_SLS_QT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SUPLYG_DIV_SUB_ENT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.WBS_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BASE_UNIT_OF_MSR_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.MATL_SLS_UNIT_OF_MSR_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PARNT_SO_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.NET_CNSTNT_3_MTH_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.NET_CNSTNT_12_MTH_SO_USD_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.REC_EXPLN_PRCS_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PARNT_PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.UNRSTD_BUS_AREA_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.TRSY_BUS_ORG_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CONV_TYPE_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CONV_RT_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CBN_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ORIG_PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.TEAM_CD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ADJ_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.QTA_PROD_LN_OVERR_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ADJ_AM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ADJ_USD_AM,CASE WHEN (STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ADJ_CD = 'ZA01' ) THEN CASE WHEN (MAP1.GL_GRP_ACCT_ID IS NOT NULL ) THEN MAP1.GL_GRP_ACCT_ID ELSE NVL(MAP1.GL_GRP_ACCT_ID, '3091') END ELSE CASE WHEN (MAP2.GL_GRP_ACCT_ID IS NOT NULL ) THEN MAP2.GL_GRP_ACCT_ID ELSE NVL(MAP2.GL_GRP_ACCT_ID, '3199') END END AS GL_GRP_ACCT_ID,LEGL_CO_D.crncy_cd AS LC_CD,crf.exch_rt AS LC_EXCH_RT,crf.MTH_3_EXCH_RT AS LC_MTH_3_EXCH_RT,crf.MTH_12_EXCH_RT AS LC_MTH_12_EXCH_RT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.VOL_DRCT_CUST_NM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.MISC_CHRG_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PROD_OPT_MCC_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_ADJ_ALLOC_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ACK_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_CMPGN_TX,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DLVR_MTHD_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.EIFFEL_INVN_CLS_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_MKT_PGM_TX,NVL(STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRVC_GDS_PROD_ID,'?') AS SRVC_GDS_PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRVC_GDS_QT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.USE_NM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.VALU_VOL_NM,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CONSOLIDTD_INV_FG,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.DRCT_CUST_IND_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.REBATE_ORD_RSN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.FULLMT_MDL_DN ,NVL(STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PKG_PROD_ID,'?') AS PKG_PROD_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.PRIM_SO_ADJ_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ENGMT_MDL_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_OPT_QT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.MSTR_CNTRCT_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CNTRCT_LN_ITM_NR_ID,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SD_ITM_CATG_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.RTE_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CUST_ACCT_GRP_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.REJ_RSN_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CNTRCT_STRT_DT AS CNTRCT_STRT_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.CNTRCT_END_DT AS CNTRCT_END_DT,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SO_PREPAYM_TYPE_CD AS SO_PREPAYM_TYPE_CD,STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.TOT_NET_EXT_SO_AM AS TOT_NET_EXT_SO_AM FROM STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL INNER JOIN SRC_SYS_D SSD ON STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRC_SYS_KY = SSD.SRC_SYS_KY LEFT JOIN (SELECT SSD1.SPRN_CO_ID,CS1.GL_GRP_ACCT_ID,CS1.BUS_TYPE_CD,CS1.BUS_AREA_CD,CS1.ACCT_BOOK_TYPE_CD FROM CONTRA_BOOK_CASE_SRVCS CS1 INNER JOIN SRC_SYS_D SSD1 ON CS1.SRC_SYS_KY = SSD1.SRC_SYS_KY)MAP1 ON STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BUS_TYPE_CD = MAP1.BUS_TYPE_CD AND STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BUS_AREA_CD = MAP1.BUS_AREA_CD AND MAP1.ACCT_BOOK_TYPE_CD = 'G' AND SSD.SPRN_CO_ID = MAP1.SPRN_CO_ID LEFT JOIN (SELECT SSD2.SPRN_CO_ID,CS2.GL_GRP_ACCT_ID,CS2.BUS_TYPE_CD,CS2.BUS_AREA_CD,CS2.ACCT_BOOK_TYPE_CD FROM CONTRA_BOOK_CASE_SRVCS CS2 INNER JOIN SRC_SYS_D SSD2 ON CS2.SRC_SYS_KY = SSD2.SRC_SYS_KY)MAP2 ON STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BUS_TYPE_CD = MAP2.BUS_TYPE_CD AND STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.BUS_AREA_CD = MAP2.BUS_AREA_CD AND MAP2.ACCT_BOOK_TYPE_CD = 'C' AND SSD.SPRN_CO_ID = MAP2.SPRN_CO_ID LEFT JOIN LEGL_CO_D LEGL_CO_D ON STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LEGL_CO_CD = LEGL_CO_D.LEGL_CO_CD AND SSD.ROLLUP_DFLT_CO_ID = LEGL_CO_D.SPRN_CO_ID LEFT JOIN crncy_rt_f crf ON STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ord_crt_dt_yr_mth_cd = crf.crncy_eff_yr_mth_cd AND STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.conv_type_id = crf.conv_type_id AND STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.conv_rt_cd = crf.conv_rt_cd AND STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.trsy_bus_org_cd = crf.trsy_bus_org_cd AND LEGL_CO_D.crncy_cd = crf.crncy_cd AND SSD.ROLLUP_DFLT_CO_ID = crf.SPRN_CO_ID  ) STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL INNER JOIN SRC_SYS_D SRC ON STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.SRC_SYS_KY = SRC.SRC_SYS_KY LEFT JOIN LEGL_CO_D LEGL_CO_D ON STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LEGL_CO_CD = LEGL_CO_D.LEGL_CO_CD AND SRC.ROLLUP_DFLT_CO_ID = LEGL_CO_D.SPRN_CO_ID LEFT JOIN crncy_rt_f crf ON (STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LC_EXCH_RT IS NULL OR STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LC_MTH_3_EXCH_RT IS NULL OR STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.LC_MTH_12_EXCH_RT IS NULL) AND STG_FIN_RZ_SO_DOR_SO_ADJ_F_ETL.ord_crt_dt_yr_mth_cd = crf.crncy_eff_yr_mth_cd AND LEGL_CO_D.crncy_cd = crf.crncy_cd AND SRC.ROLLUP_DFLT_CO_ID = crf.SPRN_CO_ID AND (crf.SPRN_CO_ID,crf.conv_type_id,crf.conv_rt_cd,crf.trsy_bus_org_cd) IN (SELECT SPRN_CO_ID,conv_type_id,conv_rt_cd,trsy_bus_org_cd FROM crncy_conv WHERE (SPRN_CO_ID,crncy_conv_id, subj_area_id, src_sys_extrc_gmt_ts) in (SELECT SCC1.SPRN_CO_ID,scc1.crncy_conv_id, scc1.subj_area_id, MAX(scc1.src_sys_extrc_gmt_ts) FROM crncy_conv scc1 WHERE scc1.subj_area_id = 'ORDER' AND scc1.crncy_conv_id = 'UNKNOWN' GROUP BY SCC1.SPRN_CO_ID,scc1.crncy_conv_id, scc1.subj_area_id  )  )  ;""" 
    ret_val = execute_sql("3", spark_session, spark_context, sql_context, query_to_execute)
    if ret_val is False:
        print("ERROR executing query {query_to_execute}".format(query_to_execute=query_to_execute))
        sys.exit(3)

    query_to_execute = """UPDATE   STG_FIN_RZ_SO_DOR_LEGL_CO_D_ETL SET Func_Area_Cd = (SELECT Func_Area_Cd FROM GL_GRP_ACCT_D T1,SRC_SYS_D SSD WHERE T1.GL_GRP_ACCT_ID = STG_FIN_RZ_SO_DOR_LEGL_CO_D_ETL.GL_GRP_ACCT_ID AND STG_FIN_RZ_SO_DOR_LEGL_CO_D_ETL.SRC_SYS_KY = SSD.SRC_SYS_KY AND SSD.ROLLUP_DFLT_CO_ID = T1.SPRN_CO_ID AND T1.ACT_FG = 'Y'   ) WHERE EXISTS (SELECT 1 FROM GL_GRP_ACCT_D,SRC_SYS_D SSD WHERE GL_GRP_ACCT_D.GL_GRP_ACCT_ID = STG_FIN_RZ_SO_DOR_LEGL_CO_D_ETL.GL_GRP_ACCT_ID AND STG_FIN_RZ_SO_DOR_LEGL_CO_D_ETL.SRC_SYS_KY = SSD.SRC_SYS_KY AND SSD.ROLLUP_DFLT_CO_ID = GL_GRP_ACCT_D.SPRN_CO_ID AND GL_GRP_ACCT_D.ACT_FG = 'Y'  ) ;""" 
    ret_val = execute_sql("4", spark_session, spark_context, sql_context, query_to_execute)
    if ret_val is False:
        print("ERROR executing query {query_to_execute}".format(query_to_execute=query_to_execute))
        sys.exit(4)


    spark_session.stop()


if __name__ == "__main__":
    # datetime object containing current date and time
    now = datetime.now()
     
    # dd/mm/YY H:M:S
    dt_string = now.strftime("%Y/%m/%d %H:%M:%S")
    file_name =  os.path.basename(sys.argv[0])
    print("{} | {} | starting execution".format(dt_string, file_name))
    
    execute()
    
    dt_string = now.strftime("%Y/%m/%d %H:%M:%S")
    
    print("{} | {} | done".format(dt_string, file_name))

#
# end
#
